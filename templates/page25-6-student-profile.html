<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Profile - HODs Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        .excel-like-table {
            border-collapse: collapse;
            width: 100%;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .excel-like-table th,
        .excel-like-table td {
            border: 1px solid #e2e8f0;
            padding: 12px;
            text-align: left;
        }
        .excel-like-table th {
            background-color: #f7fafc;
            font-weight: 600;
            color: #4a5568;
        }
        .excel-like-table tr:nth-child(even) {
            background-color: #f7fafc;
        }
        .excel-like-table tr:hover {
            background-color: #ebf8ff;
        }
        .section-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
            overflow: hidden;
        }
        .section-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem;
            font-weight: bold;
            font-size: 1.1rem;
        }
        .section-content {
            padding: 1.5rem;
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Header -->
    <header class="bg-blue-600 text-white p-6">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <img alt="Institute logo" class="mr-4" height="50" src="{{ url_for('static', filename='images/vishnu-logo.jpg') }}" width="50"/>
                <h1 class="text-2xl font-bold">Vishnu Institute Of Technology</h1>
                <h2>Bhimavaram, West Godavari District</h2>
                <h2>Affiliated to JNTUK</h2>
                <h2>Accredited by NAAC 'A+'</h2>
                <h2>Approved by AICTE</h2>
            </div>
        </div>
    </header>

    <!-- Loading Spinner -->
    <div id="loading" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden z-50">
        <div class="bg-white p-6 rounded-lg shadow-lg">
            <p class="text-blue-600 font-semibold">Loading...</p>
        </div>
    </div>

    <!-- Filters Section -->
    <div class="container mx-auto p-6">
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-bold mb-4">Student Profile Filters</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Department</label>
                    <select id="departmentFilter" class="w-full p-2 border border-gray-300 rounded-md">
                        <option value="">Select Department</option>
                        <option value="AI & DS">AI & DS</option>
                        <option value="AI & ML">AI & ML</option>
                        <option value="BS">BS</option>
                        <option value="CSBS">CSBS</option>
                        <option value="CSE">CSE</option>
                        <option value="CE">CE</option>
                        <option value="ECE">ECE</option>
                        <option value="EEE">EEE</option>
                        <option value="IT">IT</option>
                        <option value="ME">ME</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Year</label>
                    <select id="yearFilter" class="w-full p-2 border border-gray-300 rounded-md">
                        <option value="">All Years</option>
                        <option value="2024">2024</option>
                        <option value="2025">2025</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Month</label>
                    <select id="monthFilter" class="w-full p-2 border border-gray-300 rounded-md">
                        <option value="">All Months</option>
                        <option value="01">January</option>
                        <option value="02">February</option>
                        <option value="03">March</option>
                        <option value="04">April</option>
                        <option value="05">May</option>
                        <option value="06">June</option>
                        <option value="07">July</option>
                        <option value="08">August</option>
                        <option value="09">September</option>
                        <option value="10">October</option>
                        <option value="11">November</option>
                        <option value="12">December</option>
                    </select>
                </div>
            </div>
            <div class="mt-4 flex space-x-4">
                <button onclick="applyFilters()" class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700">Apply Filters</button>
                <button onclick="clearFilters()" class="bg-gray-500 text-white px-6 py-2 rounded-md hover:bg-gray-600">Clear Filters</button>
                <button onclick="exportPDF()" class="bg-green-600 text-white px-6 py-2 rounded-md hover:bg-green-700">Export PDF</button>
            </div>
        </div>
    </div>

    <!-- Student Data Sections -->
    <div class="container mx-auto p-6 space-y-6">
        
        <!-- Patents Published and Granted Section -->
        <div class="section-card">
            <div class="section-header flex justify-between items-center">
                <h3>Patents Published and Granted</h3>
                <button onclick="exportTableToExcel('student-patents-table', 'patents')" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm">Export to Excel</button>
            </div>
            <div class="section-content">
                <div class="overflow-x-auto">
                    <table class="excel-like-table" id="student-patents-table">
                        <thead>
                            <tr>
                                <th>Applicant Name</th>
                                    <th>Inventors</th>
                                    <th>Department</th>
                                    <th>Patent Title</th>
                                    <th>Patent Number</th>
                                    <th>Status</th>
                                    <th>Filed Date</th>
                                    <th>Published Date</th>
                                    <th>Granted Date</th>
                            </tr>
                        </thead>
                        <tbody id="student-patents-list">
                            <tr><td colspan="9" class="text-gray-500 text-center">Select filters and click Apply to view data</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Publications (Journals) Section -->
        <div class="section-card">
            <div class="section-header flex justify-between items-center">
                <h3>Publications (Journals)</h3>
                <button onclick="exportTableToExcel('student-journals-table', 'student_journals')" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm">Export to Excel</button>
            </div>
            <div class="section-content">
                <div class="overflow-x-auto">
                    <table class="excel-like-table" id="student-journals-table">
                        <thead>
                            <tr>
                                <th>Student Name</th>
                                <th>Registration Number</th>
                                <th>Department</th>
                                <th>Journal Type</th>
                                <th>Authors</th>
                                <th>Journal Name</th>
                                <th>Title Of Paper</th>
                                <th>ISSN</th>
                                <th>Quartile Ranking</th>
                                <th>DOI</th>
                                <th>Volume</th>
                                <th>Page</th>
                                <th>Month and Year</th>
                            </tr>
                        </thead>
                        <tbody id="student-journals-list">
                            <tr><td colspan="13" class="text-gray-500 text-center">Select filters and click Apply to view data</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Publications (Conference) Section -->
        <div class="section-card">
            <div class="section-header flex justify-between items-center">
                <h3>Publications (Conference)</h3>
                <button onclick="exportTableToExcel('student-conferences-table', 'student_conferences')" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm">Export to Excel</button>
            </div>
            <div class="section-content">
                <div class="overflow-x-auto">
                    <table class="excel-like-table" id="student-conferences-table">
                        <thead>
                            <tr>
                                <th>Student Name</th>
                                <th>Registration Number</th>
                                <th>Department</th>
                                <th>Conference Type</th>
                                <th>Authors</th>
                                <th>Conference Name</th>
                                <th>Title Of Paper</th>
                                <th>ISSN</th>
                                <th>DOI</th>
                                <th>Volume</th>
                                <th>Page</th>
                                <th>Month and Year</th>
                            </tr>
                        </thead>
                        <tbody id="student-conferences-list">
                            <tr><td colspan="12" class="text-gray-500 text-center">Select filters and click Apply to view data</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Guest lectures/ seminar/workshop attended Section -->
        <div class="section-card">
            <div class="section-header flex justify-between items-center">
                <h3>Guest lectures/ seminar/workshop attended</h3>
                <button onclick="exportTableToExcel('student-workshops-table', 'student_workshops')" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm">Export to Excel</button>
            </div>
            <div class="section-content">
                <div class="overflow-x-auto">
                    <table class="excel-like-table" id="student-workshops-table">
                        <thead>
                            <tr>
                                <th>Student Name</th>
                                <th>Registration Number</th>
                                <th>Department</th>
                                <th>Event Name</th>
                                <th>National/International</th>
                                <th>Type</th>
                                <th>Event Date</th>
                                <th>Organised by</th>
                            </tr>
                        </thead>
                        <tbody id="student-workshops-list">
                            <tr><td colspan="8" class="text-gray-500 text-center">Select filters and click Apply to view data</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Awards / achievements / recognisations Section -->
        <div class="section-card">
            <div class="section-header flex justify-between items-center">
                <h3>Awards / achievements / recognisations</h3>
                <button onclick="exportTableToExcel('student-achievements-table', 'student_achievements')" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm">Export to Excel</button>
            </div>
            <div class="section-content">
                <div class="overflow-x-auto">
                    <table class="excel-like-table" id="student-achievements-table">
                        <thead>
                            <tr>
                                <th>Student Name</th>
                                <th>Registration Number</th>
                                <th>Department</th>
                                <th>Achievement Name</th>
                                <th>Awarded By</th>
                                <th>Achievement Date</th>
                            </tr>
                        </thead>
                        <tbody id="student-achievements-list">
                            <tr><td colspan="6" class="text-gray-500 text-center">Select filters and click Apply to view data</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Visit to various industries Section -->
        <div class="section-card">
            <div class="section-header flex justify-between items-center">
                <h3>Visit to various industries</h3>
                <button onclick="exportTableToExcel('student-industry-visits-table', 'student_industry_visits')" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm">Export to Excel</button>
            </div>
            <div class="section-content">
                <div class="overflow-x-auto">
                    <table class="excel-like-table" id="student-industry-visits-table">
                        <thead>
                            <tr>
                                <th>Student Name</th>
                                <th>Registration Number</th>
                                <th>Department</th>
                                <th>Industry Name</th>
                                <th>Visited Date</th>
                                <th>Significance</th>
                                <th>Location</th>
                            </tr>
                        </thead>
                        <tbody id="student-industry-visits-list">
                            <tr><td colspan="7" class="text-gray-500 text-center">Select filters and click Apply to view data</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Vedic workshops attended Section -->
        <div class="section-card">
            <div class="section-header flex justify-between items-center">
                <h3>Vedic workshops attended</h3>
                <button onclick="exportTableToExcel('student-vedic-workshops-table', 'student_vedic_workshops')" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm">Export to Excel</button>
            </div>
            <div class="section-content">
                <div class="overflow-x-auto">
                    <table class="excel-like-table" id="student-vedic-workshops-table">
                        <thead>
                            <tr>
                                <th>Student Name</th>
                                <th>Registration Number</th>
                                <th>Department</th>
                                <th>Workshop Name</th>
                                <th>Event Date</th>
                                <th>Venue</th>
                            </tr>
                        </thead>
                        <tbody id="student-vedic-workshops-list">
                            <tr><td colspan="6" class="text-gray-500 text-center">Select filters and click Apply to view data</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Participation in outside competitions Section -->
        <div class="section-card">
            <div class="section-header flex justify-between items-center">
                <h3>Participation in outside competitions</h3>
                <button onclick="exportTableToExcel('student-competitions-table', 'student_competitions')" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm">Export to Excel</button>
            </div>
            <div class="section-content">
                <div class="overflow-x-auto">
                    <table class="excel-like-table" id="student-competitions-table">
                        <thead>
                            <tr>
                                <th>Student Name</th>
                                <th>Registration Number</th>
                                <th>Department</th>
                                <th>Competition Name</th>
                                <th>Organised By</th>
                                <th>Duration</th>
                                <th>Level</th>
                            </tr>
                        </thead>
                        <tbody id="student-competitions-list">
                            <tr><td colspan="7" class="text-gray-500 text-center">Select filters and click Apply to view data</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Sports participation & winnings Section -->
        <div class="section-card">
            <div class="section-header flex justify-between items-center">
                <h3>Sports participation & winnings</h3>
                <button onclick="exportTableToExcel('student-sports-table', 'student_sports')" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm">Export to Excel</button>
            </div>
            <div class="section-content">
                <div class="overflow-x-auto">
                    <table class="excel-like-table" id="student-sports-table">
                        <thead>
                            <tr>
                                <th>Student Name</th>
                                <th>Registration Number</th>
                                <th>Department</th>
                                <th>Year</th>
                                <th>Game Name</th>
                                <th>Game Details</th>
                                <th>Organised By</th>
                                <th>Venue</th>
                                <th>Event Start Date</th>
                                <th>Event End Date</th>
                                <th>Secured Position</th>
                                <th>Level</th>
                            </tr>
                        </thead>
                        <tbody id="student-sports-list">
                            <tr><td colspan="12" class="text-gray-500 text-center">Select filters and click Apply to view data</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Certifications Section -->
        <div class="section-card">
            <div class="section-header flex justify-between items-center">
                <h3>Certifications</h3>
                <button onclick="exportTableToExcel('student-certifications-table', 'student_certifications')" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm">Export to Excel</button>
            </div>
            <div class="section-content">
                <div class="overflow-x-auto">
                    <table class="excel-like-table" id="student-certifications-table">
                        <thead>
                            <tr>
                                <th>Student Name</th>
                                <th>Registration Number</th>
                                <th>Department</th>
                                <th>Course Title</th>
                                <th>Duration</th>
                                <th>Course Topic</th>
                                <th>Details</th>
                                <th>Certificate</th>
                            </tr>
                        </thead>
                        <tbody id="student-certifications-list">
                            <tr><td colspan="8" class="text-gray-500 text-center">Select filters and click Apply to view data</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- NPTEL/other online courses Section -->
        <div class="section-card">
            <div class="section-header flex justify-between items-center">
                <h3>NPTEL/other online courses</h3>
                <button onclick="exportTableToExcel('student-nptel-courses-table', 'student_nptel')" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm">Export to Excel</button>
            </div>
            <div class="section-content">
                <div class="overflow-x-auto">
                    <table class="excel-like-table" id="student-nptel-courses-table">
                        <thead>
                            <tr>
                                <th>Student Name</th>
                                <th>Registration Number</th>
                                <th>Department</th>
                                <th>Course Title</th>
                                <th>Duration</th>
                                <th>Course ID</th>
                                <th>Score</th>
                                <th>Platform</th>
                                <th>Details</th>
                                <th>Certificate</th>
                            </tr>
                        </thead>
                        <tbody id="student-nptel-courses-list">
                            <tr><td colspan="10" class="text-gray-500 text-center">Select filters and click Apply to view data</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <script>

        function formatDateOnly(dateStr) {
            if (!dateStr) return 'N/A';
            const d = new Date(dateStr);
            if (isNaN(d)) return dateStr;
            return d.toLocaleDateString('en-GB', {
                weekday: 'short', year: 'numeric', month: 'short', day: '2-digit'
            });
        }

        function applyFilters() {
            const department = document.getElementById('departmentFilter').value;
            const year = document.getElementById('yearFilter').value;
            const month = document.getElementById('monthFilter').value;

            if (!department) {
                alert('Please select a department');
                return;
            }

            // Show loading
            document.getElementById('loading').classList.remove('hidden');

            // Fetch all data types
            const sectionsToFetch = [
                'student-patents', 'student-journals', 'student-conferences',
                'student-workshops', 'student-achievements', 'student-industry-visits',
                'student-vedic-workshops', 'student-competitions', 'student-sports',
                'student-certifications', 'student-nptel-courses'
            ];

            sectionsToFetch.forEach(section => {
                fetchSectionData(section, department, year, month);
            });
        }

        function clearFilters() {
            document.getElementById('departmentFilter').value = '';
            document.getElementById('yearFilter').value = '';
            document.getElementById('monthFilter').value = '';
            
            // Clear all tables
            const sectionsToClear = [
                'student-patents-list', 'student-journals-list', 'student-conferences-list',
                'student-workshops-list', 'student-achievements-list', 'student-industry-visits-list',
                'student-vedic-workshops-list', 'student-competitions-list', 'student-sports-list',
                'student-certifications-list', 'student-nptel-courses-list'
            ];

            sectionsToClear.forEach(sectionId => {
                const tbody = document.getElementById(sectionId);
                tbody.innerHTML = '<tr><td colspan="10" class="text-gray-500 text-center">Select filters and click Apply to view data</td></tr>';
            });
        }

        function fetchSectionData(section, department, year, month) {
            const endpoints = {
                'student-patents': '/get_student_patents',
                'student-journals': '/get_student_journals',
                'student-conferences': '/get_student_conferences',
                'student-workshops': '/get_student_workshops',
                'student-achievements': '/get_student_achievements',
                'student-industry-visits': '/get_student_industry_visits',
                'student-vedic-workshops': '/get_student_vedic_workshops',
                'student-competitions': '/get_student_competitions',
                'student-sports': '/get_student_sports',
                'student-certifications': '/get_student_certifications',
                'student-nptel-courses': '/get_student_nptel_courses'
            };

            const tableIds = {
                'student-patents': 'student-patents-list',
                'student-journals': 'student-journals-list',
                'student-conferences': 'student-conferences-list',
                'student-workshops': 'student-workshops-list',
                'student-achievements': 'student-achievements-list',
                'student-industry-visits': 'student-industry-visits-list',
                'student-vedic-workshops': 'student-vedic-workshops-list',
                'student-competitions': 'student-competitions-list',
                'student-sports': 'student-sports-list',
                'student-certifications': 'student-certifications-list',
                'student-nptel-courses': 'student-nptel-courses-list'
            };

            const endpoint = endpoints[section];
            const tableId = tableIds[section];

            if (!endpoint || !tableId) return;

            let url = `${endpoint}?department=${encodeURIComponent(department)}`;
            if (year) url += `&year=${encodeURIComponent(year)}`;
            if (month) url += `&month=${encodeURIComponent(month)}`;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    const tbody = document.getElementById(tableId);
                    tbody.innerHTML = '';

                    if (!Array.isArray(data) || data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="10" class="text-gray-500 text-center">No data found</td></tr>';
                        return;
                    }

                    data.forEach(item => {
                        const row = document.createElement('tr');
                        row.innerHTML = generateTableRowHtml(section, item);
                        tbody.appendChild(row);
                    });
                })
                .catch(error => {
                    console.error(`Error fetching ${section} data:`, error);
                    const tbody = document.getElementById(tableId);
                    tbody.innerHTML = '<tr><td colspan="10" class="text-red-500 text-center">Error loading data</td></tr>';
                })
                .finally(() => {
                    // Hide loading after all sections are processed
                    setTimeout(() => {
                        document.getElementById('loading').classList.add('hidden');
                    }, 500);
                });
        }

        function generateTableRowHtml(section, item) {
            switch(section) {
                case 'student-patents':
                    return `
                        <td>${item.applicant_name || 'N/A'}</td>
                        <td>${item.inventors || 'N/A'}</td>
                        <td>${item.department || 'N/A'}</td>
                        <td>${item.patent_title || 'N/A'}</td>
                        <td>${item.patent_number || 'N/A'}</td>
                        <td>${item.status || 'N/A'}</td>
                        <td>${formatDateOnly(item.filed_date) || 'N/A'}</td>
                        <td>${formatDateOnly(item.published_date) || 'N/A'}</td>
                        <td>${formatDateOnly(item.granted_date) || 'N/A'}</td>
                    `;
                case 'student-journals':
                    return `
                        <td>${item.student_name || 'N/A'}</td>
                        <td>${item.registration_number || 'N/A'}</td>
                        <td>${item.department || 'N/A'}</td>
                        <td>${item.journal_type || 'N/A'}</td>
                        <td>${item.authors || 'N/A'}</td>
                        <td>${item.journal_name || 'N/A'}</td>
                        <td>${item.paper_title || 'N/A'}</td>
                        <td>${item.issn || 'N/A'}</td>
                        <td>${item.quartile_ranking || 'N/A'}</td>
                        <td>${item.doi || 'N/A'}</td>
                        <td>${item.volume || 'N/A'}</td>
                        <td>${item.page || 'N/A'}</td>
                        <td>${item.month_year || 'N/A'}</td>
                    `;
                case 'student-conferences':
                    return `
                        <td>${item.student_name || 'N/A'}</td>
                        <td>${item.registration_number || 'N/A'}</td>
                        <td>${item.department || 'N/A'}</td>
                        <td>${item.scsswsg || 'N/A'}</td>
                        <td>${item.authors_designation || 'N/A'}</td>
                        <td>${item.conference_name || 'N/A'}</td>
                        <td>${item.paper_title || 'N/A'}</td>
                        <td>${item.issn || 'N/A'}</td>
                        <td>${item.doi || 'N/A'}</td>
                        <td>${item.volume || 'N/A'}</td>
                        <td>${item.page || 'N/A'}</td>
                        <td>${item.month_year || 'N/A'}</td>
                    `;
                case 'student-workshops':
                    return `
                        <td>${item.student_name || 'N/A'}</td>
                        <td>${item.registration_number || 'N/A'}</td>
                        <td>${item.department || 'N/A'}</td>
                        <td>${item.event_name || 'N/A'}</td>
                        <td>${item.national_international || 'N/A'}</td>
                        <td>${item.event_type || 'N/A'}</td>
                        <td>${formatDateOnly(item.event_date) || 'N/A'}</td>
                        <td>${item.organized_by || 'N/A'}</td>
                    `;
                case 'student-achievements':
                    return `
                        <td>${item.student_name || 'N/A'}</td>
                        <td>${item.registration_number || 'N/A'}</td>
                        <td>${item.department || 'N/A'}</td>
                        <td>${item.achievement_name || 'N/A'}</td>
                        <td>${item.awarded_by || 'N/A'}</td>
                        <td>${item.achievement_date || 'N/A'}</td>
                    `;
                case 'student-industry-visits':
                    return `
                        <td>${item.student_name || 'N/A'}</td>
                        <td>${item.registration_number || 'N/A'}</td>
                        <td>${item.department || 'N/A'}</td>
                        <td>${item.industry_name || 'N/A'}</td>
                        <td>${formatDateOnly(item.visit_date) || 'N/A'}</td>
                        <td>${item.significance || 'N/A'}</td>
                        <td>${item.location || 'N/A'}</td>
                    `;
                case 'student-vedic-workshops':
                    return `
                        <td>${item.student_name || 'N/A'}</td>
                        <td>${item.registration_number || 'N/A'}</td>
                        <td>${item.department || 'N/A'}</td>
                        <td>${item.workshop_name || 'N/A'}</td>
                        <td>${formatDateOnly(item.event_date) || 'N/A'}</td>
                        <td>${item.venue || 'N/A'}</td>
                    `;
                case 'student-competitions':
                    return `
                        <td>${item.student_name || 'N/A'}</td>
                        <td>${item.registration_number || 'N/A'}</td>
                        <td>${item.department || 'N/A'}</td>
                        <td>${item.competition_name || 'N/A'}</td>
                        <td>${item.organized_by || 'N/A'}</td>
                        <td>${item.duration || 'N/A'}</td>
                        <td>${item.level || 'N/A'}</td>
                    `;
                case 'student-sports':
                    return `
                        <td>${item.student_name || 'N/A'}</td>
                        <td>${item.registration_number || 'N/A'}</td>
                        <td>${item.department || 'N/A'}</td>
                        <td>${item.year || 'N/A'}</td>
                        <td>${item.game_name || 'N/A'}</td>
                        <td>${item.game_details || 'N/A'}</td>
                        <td>${item.organized_by || 'N/A'}</td>
                        <td>${item.venue || 'N/A'}</td>
                        <td>${formatDateOnly(item.event_start_date) || 'N/A'}</td>
                        <td>${formatDateOnly(item.event_end_date) || 'N/A'}</td>
                        <td>${item.secured_position || 'N/A'}</td>
                        <td>${item.level || 'N/A'}</td>
                    `;
                case 'student-certifications':
                    return `
                        <td>${item.student_name || 'N/A'}</td>
                        <td>${item.registration_number || 'N/A'}</td>
                        <td>${item.department || 'N/A'}</td>
                        <td>${item.course_title || 'N/A'}</td>
                        <td>${item.duration || 'N/A'}</td>
                        <td>${item.course_topic || 'N/A'}</td>
                        <td>${item.details || 'N/A'}</td>
                        <td>
                            ${item.certificate_path && (item.certificate_path.endsWith('.jpg') || item.certificate_path.endsWith('.jpeg') || item.certificate_path.endsWith('.png') || item.certificate_path.endsWith('.bmp'))
                                ? `<img src="${item.certificate_path}" alt="Certificate Image" style="max-width:100px;max-height:100px;" onerror="this.onerror=null;this.src='/static/images/vishnu-logo.jpg';">`
                                : (item.certificate_path ? `<a href="${item.certificate_path}" target="_blank" class="text-blue-600 hover:underline">View Certificate</a>` : 'N/A')}
                        </td>
                    `;
                case 'student-nptel-courses':
                    return `
                        <td>${item.student_name || 'N/A'}</td>
                        <td>${item.registration_number || 'N/A'}</td>
                        <td>${item.department || 'N/A'}</td>
                        <td>${item.course_title || 'N/A'}</td>
                        <td>${item.duration || 'N/A'}</td>
                        <td>${item.course_id || 'N/A'}</td>
                        <td>${item.score || 'N/A'}</td>
                        <td>${item.platform || 'N/A'}</td>
                        <td>${item.details || 'N/A'}</td>
                        <td>
                            ${item.certificate_path && (item.certificate_path.endsWith('.jpg') || item.certificate_path.endsWith('.jpeg') || item.certificate_path.endsWith('.png') || item.certificate_path.endsWith('.bmp'))
                                ? `<img src="${item.certificate_path}" alt="Certificate Image" style="max-width:100px;max-height:100px;" onerror="this.onerror=null;this.src='/static/images/vishnu-logo.jpg';">`
                                : (item.certificate_path ? `<a href="${item.certificate_path}" target="_blank" class="text-blue-600 hover:underline">View Certificate</a>` : 'N/A')}
                        </td>
                    `;
                default:
                    return '<td colspan="10">Data not available</td>';
            }
        }

        // Export table to Excel function
        function exportTableToExcel(tableID, filename = '') {
            const table = document.getElementById(tableID);
            if (!table) {
                alert('Table not found!');
                return;
            }

            // Get all rows from the table
            const rows = table.querySelectorAll('tr');
            
            // Check if table has actual data (not just 'No data found' or 'Select filters' messages)
            let hasData = false;
            let messageRow = false;
            
            // First check if we have more than just a header row
            if (rows.length <= 1) {
                alert('No data to export! Please apply filters first to load data.');
                return;
            }
            
            // Then check if the data rows contain actual data and not just messages
            for (let i = 1; i < rows.length; i++) { // Skip header row
                const row = rows[i];
                const firstCell = row.querySelector('td');
                if (!firstCell) continue;
                
                const colspan = firstCell.getAttribute('colspan');
                
                // Check if this is a message row
                if (colspan && parseInt(colspan) > 1 && 
                    (firstCell.textContent.includes('No data') || 
                     firstCell.textContent.includes('Select filters') || 
                     firstCell.textContent.includes('Error loading'))) {
                    messageRow = true;
                    continue;
                }
                
                // If we have a row with multiple cells or a single cell that's not a message
                if (row.querySelectorAll('td').length > 1 || !messageRow) {
                    hasData = true;
                    break;
                }
            }
            
            if (!hasData) {
                alert('No data to export! Please apply filters first to load data.');
                return;
            }

            // Create a workbook and worksheet
            const wb = XLSX.utils.book_new();
            const wsData = [];

            // Get headers from the first row
            const headerRow = rows[0];
            const headers = [];
            headerRow.querySelectorAll('th').forEach(cell => {
                headers.push(cell.innerText.trim());
            });
            wsData.push(headers);

            // Get data from the remaining rows
            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                const rowData = [];
                row.querySelectorAll('td').forEach(cell => {
                    // Skip image cells and get only text content
                    if (cell.querySelector('img')) {
                        rowData.push('Image');
                    } else if (cell.querySelector('a')) {
                        rowData.push(cell.querySelector('a').innerText.trim());
                    } else {
                        rowData.push(cell.innerText.trim());
                    }
                });
                wsData.push(rowData);
            }

            // Create worksheet and add to workbook
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            XLSX.utils.book_append_sheet(wb, ws, 'Sheet1');

            // Generate Excel file and trigger download
            XLSX.writeFile(wb, filename + '.xlsx');
        }

        // Export PDF function for dashboard tables
        function exportPDF() {
            const pdf = new window.jspdf.jsPDF('l', 'pt', 'a4');
            const container = document.querySelector('.container.mx-auto.p-6.space-y-6');
            if (!container) {
                alert('No data to export!');
                return;
            }
            // Hide loading spinner if visible
            document.getElementById('loading').classList.add('hidden');

            // Use html2canvas to render the dashboard tables
            html2canvas(container, { scale: 2 }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();
                const imgProps = pdf.getImageProperties(imgData);
                const pdfWidth = pageWidth;
                const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;

                let position = 0;
                pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, pdfHeight);

                // If content is longer than one page, add more pages
                if (pdfHeight > pageHeight) {
                    let remainingHeight = pdfHeight - pageHeight;
                    let pageCount = Math.ceil(pdfHeight / pageHeight);
                    for (let i = 1; i < pageCount; i++) {
                        pdf.addPage();
                        pdf.addImage(imgData, 'PNG', 0, -i * pageHeight, pdfWidth, pdfHeight);
                    }
                }

                pdf.save('student-profile-dashboard.pdf');
            });
        }
    </script>
</body>
</html>