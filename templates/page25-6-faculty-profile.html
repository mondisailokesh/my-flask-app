<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Faculty Profile - HODs Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <style>
        .excel-like-table {
            border-collapse: collapse;
            width: 100%;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .excel-like-table th,
        .excel-like-table td {
            border: 1px solid #e2e8f0;
            padding: 12px;
            text-align: left;
        }
        .excel-like-table th {
            background-color: #f7fafc;
            font-weight: 600;
            color: #4a5568;
        }
        .excel-like-table tr:nth-child(even) {
            background-color: #f7fafc;
        }
        .excel-like-table tr:hover {
            background-color: #ebf8ff;
        }
        .section-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
            overflow: hidden;
        }
        .section-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem;
            font-weight: bold;
            font-size: 1.1rem;
        }
        .section-content {
            padding: 1.5rem;
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Header -->
    <header class="bg-blue-600 text-white p-6">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <img alt="Institute logo" class="mr-4" height="50" src="{{ url_for('static', filename='images/vishnu-logo.jpg') }}" width="50"/>
                <h1 class="text-2xl font-bold">Vishnu Institute Of Technology</h1>
                <h2>Bhimavaram, West Godavari District</h2>
                <h2>Affiliated to JNTUK</h2>
                <h2>Accredited by NAAC 'A+'</h2>
                <h2>Approved by AICTE</h2>
            </div>
        </div>
    </header>

    <div class="container mx-auto mt-6 flex justify-end">
        <button id="viewFacultyDetailsBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow">View Faculty Details</button>
    </div>

    <!-- Modal for Faculty Details -->
    <div id="facultyDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-lg w-full max-w-4xl p-6 relative">
            <button id="closeFacultyDetailsModal" class="absolute top-2 right-2 text-gray-500 hover:text-red-600 text-2xl">&times;</button>
            <h2 class="text-xl font-bold mb-4">All Faculty Details (<span id="facultyCount">0</span> records)</h2>
            <button id="exportFacultyExcel" class="mb-4 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow">Export as Excel</button>
            <div class="overflow-x-auto max-h-[60vh]">
                <table class="min-w-full border border-gray-300 text-sm" id="facultyDetailsTable">
                    <thead>
                        <tr id="facultyDetailsHeader"></tr>
                    </thead>
                    <tbody id="facultyDetailsBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loading" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden z-50">
        <div class="bg-white p-6 rounded-lg shadow-lg">
            <p class="text-blue-600 font-semibold">Loading...</p>
        </div>
    </div>

    <!-- Filters Section -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const btn = document.getElementById('viewFacultyDetailsBtn');
        const modal = document.getElementById('facultyDetailsModal');
        const closeBtn = document.getElementById('closeFacultyDetailsModal');
        const tableHeader = document.getElementById('facultyDetailsHeader');
        const tableBody = document.getElementById('facultyDetailsBody');
        const countSpan = document.getElementById('facultyCount');
        const exportBtn = document.getElementById('exportFacultyExcel');
        let lastFacultyData = [];

        btn.addEventListener('click', function() {
            modal.classList.remove('hidden');
            fetch('/get_all_faculty_details')
                .then(res => res.json())
                .then(data => {
                    if (data.error) {
                        tableHeader.innerHTML = '';
                        tableBody.innerHTML = `<tr><td colspan="100" class="text-red-600">${data.error}</td></tr>`;
                        countSpan.textContent = 0;
                        lastFacultyData = [];
                        return;
                    }
                    countSpan.textContent = data.count;
                    lastFacultyData = data.records;
                    if (data.records.length > 0) {
                        // Set table headers
                        const keys = Object.keys(data.records[0]);
                        tableHeader.innerHTML = keys.map(k => `<th class="border px-2 py-1">${k}</th>`).join('');
                        // Set table body
                        tableBody.innerHTML = data.records.map(row =>
                            `<tr>${keys.map(k => `<td class="border px-2 py-1">${row[k] ?? ''}</td>`).join('')}</tr>`
                        ).join('');
                    } else {
                        tableHeader.innerHTML = '';
                        tableBody.innerHTML = '<tr><td colspan="100">No records found.</td></tr>';
                    }
                });
        });
        closeBtn.addEventListener('click', function() {
            modal.classList.add('hidden');
        });
        // Hide modal on outside click
        modal.addEventListener('click', function(e) {
            if (e.target === modal) modal.classList.add('hidden');
        });

        // Export as Excel functionality
        exportBtn.addEventListener('click', function() {
            if (!lastFacultyData.length) {
                alert('No data to export!');
                return;
            }
            const ws = XLSX.utils.json_to_sheet(lastFacultyData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'FacultyDetails');
            XLSX.writeFile(wb, 'faculty_details.xlsx');
        });
    });
    </script>
    <div class="container mx-auto p-6">
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-bold mb-4">Faculty Profile Filters</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Department</label>
                    <select id="departmentFilter" class="w-full p-2 border border-gray-300 rounded-md">
                        <option value="">Select Department</option>
                        <option value="AI & DS">AI & DS</option>
                        <option value="AI & ML">AI & ML</option>
                        <option value="BS">BS</option>
                        <option value="CSBS">CSBS</option>
                        <option value="CSE">CSE</option>
                        <option value="CE">CE</option>
                        <option value="ECE">ECE</option>
                        <option value="EEE">EEE</option>
                        <option value="IT">IT</option>
                        <option value="ME">ME</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Faculty Name</label>
                    <select id="facultyFilter" class="w-full p-2 border border-gray-300 rounded-md">
                        <option value="">Select Faculty</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Year</label>
                    <select id="yearFilter" class="w-full p-2 border border-gray-300 rounded-md">
                        <option value="">All Years</option>
                        <option value="2024">2024</option>
                        <option value="2025">2025</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Month</label>
                    <select id="monthFilter" class="w-full p-2 border border-gray-300 rounded-md">
                        <option value="">All Months</option>
                        <option value="01">January</option>
                        <option value="02">February</option>
                        <option value="03">March</option>
                        <option value="04">April</option>
                        <option value="05">May</option>
                        <option value="06">June</option>
                        <option value="07">July</option>
                        <option value="08">August</option>
                        <option value="09">September</option>
                        <option value="10">October</option>
                        <option value="11">November</option>
                        <option value="12">December</option>
                    </select>
                </div>
            </div>
            <div class="mt-4 flex space-x-4">
                <button onclick="applyFilters()" class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700">Apply Filters</button>
                <button onclick="clearFilters()" class="bg-gray-500 text-white px-6 py-2 rounded-md hover:bg-gray-600">Clear Filters</button>
                <button onclick="exportPDF()" class="bg-green-600 text-white px-6 py-2 rounded-md hover:bg-green-700">Export PDF</button>
            </div>
        </div>
    </div>

    <!-- Faculty Data Sections -->
    <div class="container mx-auto p-6 space-y-6">
        
        <!-- Patents Section -->
        <div class="section-card">
            <div class="section-header flex justify-between items-center">
                <h3>Patents Published and Granted</h3>
                <button onclick="exportTableToExcel('patents-list', 'patents')" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm">Export to Excel</button>
            </div>
            <div class="section-content">
                <div class="overflow-x-auto">
                    <table class="excel-like-table">
                        <thead>
                            <tr>
                                <th>Applicant Name</th>
                                <th>Inventors</th>
                                <th>Department</th>
                                <th>Patent Title</th>
                                <th>Patent Number</th>
                                <th>Status</th>
                                <th>Filed Date</th>
                                <th>Published Date</th>
                                <th>Granted Date</th>
                            </tr>
                        </thead>
                        <tbody id="patents-list">
                            <tr><td colspan="9" class="text-gray-500 text-center">Select filters and click Apply to view data</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Research Grants Section -->
        <div class="section-card">
            <div class="section-header flex justify-between items-center">
                <h3>Research Grants / Status</h3>
                <button onclick="exportTableToExcel('research-grants-list', 'research_grants')" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm">Export to Excel</button>
            </div>
            <div class="section-content">
                <div class="overflow-x-auto">
                    <table class="excel-like-table">
                        <thead>
                            <tr>
                                <th>Faculty Name</th>
                                <th>Department</th>
                                <th>Project ID</th>
                                <th>Project Title</th>
                                <th>Funding Agency</th>
                                <th>Principal Investigator</th>
                                <th>Co-PI</th>
                                <th>Project Duration</th>
                                <th>Total Grant Sanctioned</th>
                            </tr>
                        </thead>
                        <tbody id="research-grants-list">
                            <tr><td colspan="9" class="text-gray-500 text-center">Select filters and click Apply to view data</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Consultancy Section -->
        <div class="section-card">
            <div class="section-header flex justify-between items-center">
                <h3>Consultancy</h3>
                <button onclick="exportTableToExcel('consultancy-list', 'consultancy')" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm">Export to Excel</button>
            </div>
            <div class="section-content">
                <div class="overflow-x-auto">
                    <table class="excel-like-table">
                        <thead>
                            <tr>
                                <th>Consultancy Name</th>
                                <th>Department</th>
                                <th>Funding Agency</th>
                                <th>Faculty Names</th>
                                <th>Duration</th>
                                <th>Amount Granted</th>
                            </tr>
                        </thead>
                        <tbody id="consultancy-list">
                            <tr><td colspan="6" class="text-gray-500 text-center">Select filters and click Apply to view data</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Publications (Journals) Section -->
        <div class="section-card">
            <div class="section-header flex justify-between items-center">
                <h3>Publications (Journals)</h3>
                <button onclick="exportTableToExcel('journals-list', 'journals')" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm">Export to Excel</button>
            </div>
            <div class="section-content">
                <div class="overflow-x-auto">
                    <table class="excel-like-table">
                        <thead>
                            <tr>
                                <th>Faculty Name</th>
                                <th>Department</th>
                                <th>Journal Type</th>
                                <th>Authors</th>
                                <th>Journal Name</th>
                                <th>Title Of Paper</th>
                                <th>ISSN</th>
                                <th>Quartile Ranking</th>
                                <th>DOI</th>
                                <th>Volume</th>
                                <th>Page</th>
                                <th>Month and Year</th>
                            </tr>
                        </thead>
                        <tbody id="journals-list">
                            <tr><td colspan="12" class="text-gray-500 text-center">Select filters and click Apply to view data</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Publications (Conference) Section -->
        <div class="section-card">
            <div class="section-header flex justify-between items-center">
                <h3>Publications (Conference)</h3>
                <button onclick="exportTableToExcel('conferences-list', 'conferences')" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm">Export to Excel</button>
            </div>
            <div class="section-content">
                <div class="overflow-x-auto">
                    <table class="excel-like-table">
                        <thead>
                            <tr>
                                <th>Faculty Name</th>
                                <th>Department</th>
                                <th>Conference Type</th>
                                <th>Authors</th>
                                <th>Conference Name</th>
                                <th>Title Of Paper</th>
                                <th>ISSN</th>
                                <th>DOI</th>
                                <th>Volume</th>
                                <th>Page</th>
                                <th>Month and Year</th>
                            </tr>
                        </thead>
                        <tbody id="conferences-list">
                            <tr><td colspan="11" class="text-gray-500 text-center">Select filters and click Apply to view data</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Resource Person Section -->
        <div class="section-card">
            <div class="section-header flex justify-between items-center">
                <h3>Faculty acted as a Resource Person</h3>
                <button onclick="exportTableToExcel('resource-person-list', 'resource_person')" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm">Export to Excel</button>
            </div>
            <div class="section-content">
                <div class="overflow-x-auto">
                    <table class="excel-like-table">
                        <thead>
                            <tr>
                                <th>Faculty Name</th>
                                <th>Department</th>
                                <th>Date Of Activity</th>
                                <th>College Name</th>
                                <th>Resource Activity</th>
                                <th>Remarks</th>
                            </tr>
                        </thead>
                        <tbody id="resource-list">
                            <tr><td colspan="6" class="text-gray-500 text-center">Select filters and click Apply to view data</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Book Publications Section -->
        <div class="section-card">
            <div class="section-header flex justify-between items-center">
                <h3>Book Publications</h3>
                <button onclick="exportTableToExcel('books-list', 'book_publications')" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm">Export to Excel</button>
            </div>
            <div class="section-content">
                <div class="overflow-x-auto">
                    <table class="excel-like-table">
                        <thead>
                            <tr>
                                <th>Faculty Name</th>
                                <th>Designation</th>
                                <th>Department</th>
                                <th>Book Type</th>
                                <th>Book Title</th>
                                <th>ISSN</th>
                                <th>Indexed in</th>
                                <th>Publishing Agency</th>
                                <th>Month and Year</th>
                            </tr>
                        </thead>
                        <tbody id="books-list">
                            <tr><td colspan="9" class="text-gray-500 text-center">Select filters and click Apply to view data</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Industry Visits Section -->
        <div class="section-card">
            <div class="section-header flex justify-between items-center">
                <h3>Industries Visited</h3>
                <button onclick="exportTableToExcel('industry-visits-list', 'industry_visits')" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm">Export to Excel</button>
            </div>
            <div class="section-content">
                <div class="overflow-x-auto">
                    <table class="excel-like-table">
                        <thead>
                            <tr>
                                <th>Faculty Name</th>
                                <th>Department</th>
                                <th>Industry Name</th>
                                <th>Visited Date</th>
                                <th>Significance</th>
                                <th>Location</th>
                            </tr>
                        </thead>
                        <tbody id="industry-visits-list">
                            <tr><td colspan="6" class="text-gray-500 text-center">Select filters and click Apply to view data</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- HRD/FDP/SDP Section -->
        <div class="section-card">
            <div class="section-header flex justify-between items-center">
                <h3>HRD/FDP/SDP's Attended</h3>
                <button onclick="exportTableToExcel('hrd-fdp-list', 'hrd_fdp_sdp')" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm">Export to Excel</button>
            </div>
            <div class="section-content">
                <div class="overflow-x-auto">
                    <table class="excel-like-table">
                        <thead>
                            <tr>
                                <th>Faculty Name</th>
                                <th>Department</th>
                                <th>Event Name</th>
                                <th>Event Type</th>
                                <th>Starting Date</th>
                                <th>Ending Date</th>
                                <th>Organised By</th>
                                <th>National/International</th>
                                <th>Mode</th>
                            </tr>
                        </thead>
                        <tbody id="hrd-fdp-list">
                            <tr><td colspan="9" class="text-gray-500 text-center">Select filters and click Apply to view data</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Workshop/Seminar/Guest Lectures Section -->
        <div class="section-card">
            <div class="section-header flex justify-between items-center">
                <h3>Workshop/Seminar/Guest Lectures Attended</h3>
                <button onclick="exportTableToExcel('workshops-list', 'workshops_seminars')" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm">Export to Excel</button>
            </div>
            <div class="section-content">
                <div class="overflow-x-auto">
                    <table class="excel-like-table">
                        <thead>
                            <tr>
                                <th>Faculty Name</th>
                                <th>Department</th>
                                <th>Event Name</th>
                                <th>National/International</th>
                                <th>Type</th>
                                <th>Starting Date</th>
                                <th>Ending Date</th>
                                <th>Organised by</th>
                            </tr>
                        </thead>
                        <tbody id="workshops-list">
                            <tr><td colspan="8" class="text-gray-500 text-center">Select filters and click Apply to view data</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Achievements Section -->
        <div class="section-card">
            <div class="section-header flex justify-between items-center">
                <h3>Awards / Achievements / Recognitions</h3>
                <button onclick="exportTableToExcel('achievements-list', 'achievements')" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm">Export to Excel</button>
            </div>
            <div class="section-content">
                <div class="overflow-x-auto">
                    <table class="excel-like-table">
                        <thead>
                            <tr>
                                <th>Faculty Name</th>
                                <th>Department</th>
                                <th>Achievement Name</th>
                                <th>Awarded By</th>
                                <th>Month & Year</th>
                            </tr>
                        </thead>
                        <tbody id="achievements-list">
                            <tr><td colspan="5" class="text-gray-500 text-center">Select filters and click Apply to view data</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Vedic Workshops Section -->
        <div class="section-card">
            <div class="section-header flex justify-between items-center">
                <h3>Vedic Workshops Attended</h3>
                <button onclick="exportTableToExcel('vedic-workshops-list', 'vedic_workshops')" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm">Export to Excel</button>
            </div>
            <div class="section-content">
                <div class="overflow-x-auto">
                    <table class="excel-like-table">
                        <thead>
                            <tr>
                                <th>Faculty Name</th>
                                <th>Department</th>
                                <th>Workshop Name</th>
                                <th>Event Date</th>
                                <th>Venue</th>
                            </tr>
                        </thead>
                        <tbody id="vedic-workshops-list">
                            <tr><td colspan="5" class="text-gray-500 text-center">Select filters and click Apply to view data</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- PhD Supervisor Section -->
        <div class="section-card">
            <div class="section-header flex justify-between items-center">
                <h3>Ph.D Supervisor Data</h3>
                <button onclick="exportTableToExcel('phd-supervisor-list', 'phd_supervisor')" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm">Export to Excel</button>
            </div>
            <div class="section-content">
                <div class="overflow-x-auto">
                    <table class="excel-like-table">
                        <thead>
                            <tr>
                                <th>Supervisor Name</th>
                                <th>Research Scholar Name</th>
                                <th>Department</th>
                                <th>University Name</th>
                                <th>Full time/Part time</th>
                                <th>Month & Year</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="phd-supervisor-list">
                            <tr><td colspan="7" class="text-gray-500 text-center">Select filters and click Apply to view data</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Conference and Journals Reviewer Section -->
        <div class="section-card">
            <div class="section-header flex justify-between items-center">
                <h3>Conference and Journals Reviewer</h3>
                <button onclick="exportTableToExcel('reviewer-list', 'conference_journal_reviewer')" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm">Export to Excel</button>
            </div>
            <div class="section-content">
                <div class="overflow-x-auto">
                    <table class="excel-like-table">
                        <thead>
                            <tr>
                                <th>Faculty Name</th>
                                <th>Department</th>
                                <th>Date Of Review</th>
                                <th>Conference/Journal Name</th>
                                <th>Type</th>
                                <th>Remarks</th>
                            </tr>
                        </thead>
                        <tbody id="reviewer-list">
                            <tr><td colspan="6" class="text-gray-500 text-center">Select filters and click Apply to view data</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Certifications Section -->
        <div class="section-card">
            <div class="section-header flex justify-between items-center">
                <h3>Certifications</h3>
                <button onclick="exportTableToExcel('certifications-list', 'certifications')" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm">Export to Excel</button>
            </div>
            <div class="section-content">
                <div class="overflow-x-auto">
                    <table class="excel-like-table">
                        <thead>
                            <tr>
                                <th>Faculty Name</th>
                                <th>Department</th>
                                <th>Course Title</th>
                                <th>Course Duration</th>
                                <th>Course Topic</th>
                                <th>Course Details</th>
                                <th>Certificate</th>
                            </tr>
                        </thead>
                        <tbody id="certifications-list">
                            <tr><td colspan="7" class="text-gray-500 text-center">Select filters and click Apply to view data</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- NPTEL/Online Courses Section -->
        <div class="section-card">
            <div class="section-header flex justify-between items-center">
                <h3>NPTEL/Other Online Courses</h3>
                <button onclick="exportTableToExcel('nptel-courses-list', 'nptel_online_courses')" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm">Export to Excel</button>
            </div>
            <div class="section-content">
                <div class="overflow-x-auto">
                    <table class="excel-like-table">
                        <thead>
                            <tr>
                                <th>Faculty Name</th>
                                <th>Department</th>
                                <th>Course Title</th>
                                <th>Course Duration</th>
                                <th>Course ID</th>
                                <th>Score</th>
                                <th>Platform</th>
                                <th>Details</th>
                                <th>Certificate</th>
                            </tr>
                        </thead>
                        <tbody id="nptel-courses-list">
                            <tr><td colspan="9" class="text-gray-500 text-center">Select filters and click Apply to view data</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <script>

        function formatDateOnly(dateStr) {
            if (!dateStr) return 'N/A';
            const d = new Date(dateStr);
            if (isNaN(d)) return dateStr;
            // Format: 'Mon, 10 Feb 2025'
            return d.toLocaleDateString('en-GB', {
                weekday: 'short', year: 'numeric', month: 'short', day: '2-digit'
            });
        }
        
        // Function to export table data to Excel
        function exportTableToExcel(tableId, filename) {
            const table = document.getElementById(tableId);
            if (!table) {
                alert('Table not found!');
                return;
            }
            
            // Check if table has data (excluding rows with 'No data found' or similar messages)
            let hasData = false;
            let messageRow = false;
            
            // First check if we have any rows
            if (table.rows.length === 0) {
                alert('No data to export! Please apply filters first to load data.');
                return;
            }
            
            for (let i = 0; i < table.rows.length; i++) {
                const row = table.rows[i];
                if (row.cells.length === 0) continue;
                
                const firstCell = row.cells[0];
                if (!firstCell) continue;
                
                const colspan = firstCell.getAttribute('colspan');
                
                // Check if this is a message row
                if (colspan && parseInt(colspan) > 1 && 
                    (firstCell.textContent.includes('No data') || 
                     firstCell.textContent.includes('Select filters') || 
                     firstCell.textContent.includes('Error loading'))) {
                    messageRow = true;
                    continue;
                }
                
                // If we have a row with multiple cells or a single cell that's not a message
                if (row.cells.length > 1 || !messageRow) {
                    hasData = true;
                    break;
                }
            }
            
            if (!hasData) {
                alert('No data to export! Please apply filters first to load data.');
                return;
            }

            // Get the table headers
            const headerRow = table.parentElement.querySelector('thead tr');
            const headers = [];
            for (let i = 0; i < headerRow.cells.length; i++) {
                headers.push(headerRow.cells[i].innerText);
            }

            // Create worksheet data
            const wsData = [headers];

            // Add table data rows
            for (let i = 0; i < table.rows.length; i++) {
                const row = table.rows[i];
                // Skip empty state message row
                if (row.cells.length === 1 && row.cells[0].colSpan > 1) continue;
                
                const rowData = [];
                for (let j = 0; j < row.cells.length; j++) {
                    // Clean the cell text (remove any HTML)
                    const cellText = row.cells[j].innerText.trim();
                    rowData.push(cellText);
                }
                wsData.push(rowData);
            }

            // Create a worksheet
            const ws = XLSX.utils.aoa_to_sheet(wsData);

            // Create a workbook
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Sheet1');

            // Generate Excel file and trigger download
            XLSX.writeFile(wb, filename + '.xlsx');
        }

        // Load faculty names when department is selected
        document.getElementById('departmentFilter').addEventListener('change', function() {
            const department = this.value;
            const facultySelect = document.getElementById('facultyFilter');
            
            if (department) {
                fetch(`/get_faculty_names?department=${encodeURIComponent(department)}`)
                    .then(response => response.json())
                    .then(names => {
                        facultySelect.innerHTML = '<option value="">Select Faculty</option>';
                        names.forEach(faculty => {
                            const option = document.createElement('option');
                            option.value = faculty.faculty_name;
                            option.textContent = faculty.faculty_name;
                            facultySelect.appendChild(option);
                        });
                    })
                    .catch(error => {
                        console.error('Error fetching faculty names:', error);
                        facultySelect.innerHTML = '<option value="">Error loading faculty names</option>';
                    });
            } else {
                facultySelect.innerHTML = '<option value="">Select Faculty</option>';
            }
        });

        function applyFilters() {
            const department = document.getElementById('departmentFilter').value;
            const faculty = document.getElementById('facultyFilter').value;
            const year = document.getElementById('yearFilter').value;
            const month = document.getElementById('monthFilter').value;

            if (!department) {
                alert('Please select a department');
                return;
            }

            // Show loading
            document.getElementById('loading').classList.remove('hidden');

            // Fetch all data types
            const sectionsToFetch = [
                'patents', 'research-grants', 'consultancy', 'journals', 'conferences',
                'resource', 'books', 'industry-visits', 'hrd-fdp', 'workshops',
                'achievements', 'vedic-workshops', 'phd-supervisor', 'reviewer',
                'certifications', 'nptel-courses'
            ];

            sectionsToFetch.forEach(section => {
                fetchSectionData(section, department, faculty, year, month);
            });
        }

        function clearFilters() {
            document.getElementById('departmentFilter').value = '';
            document.getElementById('facultyFilter').value = '';
            document.getElementById('yearFilter').value = '';
            document.getElementById('monthFilter').value = '';
            
            // Clear all tables
            const sectionsToClear = [
                'patents-list', 'research-grants-list', 'consultancy-list', 'journals-list',
                'conferences-list', 'resource-list', 'books-list', 'industry-visits-list',
                'hrd-fdp-list', 'workshops-list', 'achievements-list', 'vedic-workshops-list',
                'phd-supervisor-list', 'reviewer-list', 'certifications-list', 'nptel-courses-list'
            ];

            sectionsToClear.forEach(sectionId => {
                const tbody = document.getElementById(sectionId);
                tbody.innerHTML = '<tr><td colspan="10" class="text-gray-500 text-center">Select filters and click Apply to view data</td></tr>';
            });
        }

        function fetchSectionData(section, department, faculty, year, month) {
            const endpoints = {
                'patents': '/get_faculty_patents',
                'research-grants': '/get_research_grants',
                'consultancy': '/get_consultancy',
                'journals': '/get_faculty_journals',
                'conferences': '/get_faculty_conferences',
                'resource': '/get_faculty_resource_person',
                'books': '/get_book_publications',
                'industry-visits': '/get_faculty_industry_visits',
                'hrd-fdp': '/get_faculty_hrd_fdp_sdp',
                'workshops': '/get_faculty_ws_sem_gs',
                'achievements': '/get_faculty_achievements',
                'vedic-workshops': '/get_faculty_vedic_workshops',
                'phd-supervisor': '/get_phd_supervisor_details',
                'reviewer': '/get_conference_journal_reviewer',
                'certifications': '/get_faculty_certifications',
                'nptel-courses': '/get_faculty_nptel_courses'
            };

            const tableIds = {
                'patents': 'patents-list',
                'research-grants': 'research-grants-list',
                'consultancy': 'consultancy-list',
                'journals': 'journals-list',
                'conferences': 'conferences-list',
                'resource': 'resource-list',
                'books': 'books-list',
                'industry-visits': 'industry-visits-list',
                'hrd-fdp': 'hrd-fdp-list',
                'workshops': 'workshops-list',
                'achievements': 'achievements-list',
                'vedic-workshops': 'vedic-workshops-list',
                'phd-supervisor': 'phd-supervisor-list',
                'reviewer': 'reviewer-list',
                'certifications': 'certifications-list',
                'nptel-courses': 'nptel-courses-list'
            };

            const endpoint = endpoints[section];
            const tableId = tableIds[section];

            if (!endpoint || !tableId) return;

            let url = `${endpoint}?department=${encodeURIComponent(department)}`;
            if (faculty) url += `&faculty=${encodeURIComponent(faculty)}`;
            if (year) url += `&year=${encodeURIComponent(year)}`;
            if (month) url += `&month=${encodeURIComponent(month)}`;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    const tbody = document.getElementById(tableId);
                    tbody.innerHTML = '';

                    if (!Array.isArray(data) || data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="10" class="text-gray-500 text-center">No data found</td></tr>';
                        return;
                    }

                    data.forEach(item => {
                        const row = document.createElement('tr');
                        row.innerHTML = generateTableRowHtml(section, item);
                        tbody.appendChild(row);
                    });
                })
                .catch(error => {
                    console.error(`Error fetching ${section} data:`, error);
                    const tbody = document.getElementById(tableId);
                    tbody.innerHTML = '<tr><td colspan="10" class="text-red-500 text-center">Error loading data</td></tr>';
                })
                .finally(() => {
                    // Hide loading after all sections are processed
                    setTimeout(() => {
                        document.getElementById('loading').classList.add('hidden');
                    }, 500);
                });
        }

        function generateTableRowHtml(section, item) {
            switch(section) {
                case 'patents':
                    return `
                        <td>${item.applicant_name || 'N/A'}</td>
                        <td>${item.inventors || 'N/A'}</td>
                        <td>${item.department || 'N/A'}</td>
                        <td>${item.patent_title || 'N/A'}</td>
                        <td>${item.patent_number || 'N/A'}</td>
                        <td>${item.status || 'N/A'}</td>
                        <td>${formatDateOnly(item.filed_date) || 'N/A'}</td>
                        <td>${formatDateOnly(item.published_date) || 'N/A'}</td>
                        <td>${formatDateOnly(item.granted_date) || 'N/A'}</td>
                    `;
                case 'research-grants':
                    return `
                        <td>${item.faculty_name || 'N/A'}</td>
                        <td>${item.department || 'N/A'}</td>
                        <td>${item.project_id || 'N/A'}</td>
                        <td>${item.project_title || 'N/A'}</td>
                        <td>${item.funding_agency || 'N/A'}</td>
                        <td>${item.principle_investigator || 'N/A'}</td>
                        <td>${item.co_pi || 'N/A'}</td>
                        <td>${item.project_duration || 'N/A'}</td>
                        <td>${item.total_grant_sanctioned || 'N/A'}</td>
                    `;
                case 'consultancy':
                    return `
                        <td>${item.consultancy_name || 'N/A'}</td>
                        <td>${item.department || 'N/A'}</td>
                        <td>${item.funding_agency || 'N/A'}</td>
                        <td>${item.faculty_names || 'N/A'}</td>
                        <td>${item.duration || 'N/A'}</td>
                        <td>${item.amount_granted || 'N/A'}</td>
                    `;
                case 'journals':
                    return `
                        <td>${item.faculty_name || 'N/A'}</td>
                        <td>${item.department || 'N/A'}</td>
                        <td>${item.journal_type || 'N/A'}</td>
                        <td>${item.authors_designations || 'N/A'}</td>
                        <td>${item.journal_name || 'N/A'}</td>
                        <td>${item.paper_title || 'N/A'}</td>
                        <td>${item.issn || 'N/A'}</td>
                        <td>${item.quartile_ranking || 'N/A'}</td>
                        <td>${item.doi || 'N/A'}</td>
                        <td>${item.volume || 'N/A'}</td>
                        <td>${item.page || 'N/A'}</td>
                        <td>${item.month_and_year || 'N/A'}</td>
                    `;
                case 'conferences':
                    return `
                        <td>${item.faculty_name || 'N/A'}</td>
                        <td>${item.department || 'N/A'}</td>
                        <td>${item.conference_type || 'N/A'}</td>
                        <td>${item.authors_designations || 'N/A'}</td>
                        <td>${item.conference_name || 'N/A'}</td>
                        <td>${item.paper_title || 'N/A'}</td>
                        <td>${item.issn || 'N/A'}</td>
                        <td>${item.doi || 'N/A'}</td>
                        <td>${item.volume || 'N/A'}</td>
                        <td>${item.page || 'N/A'}</td>
                        <td>${item.month_and_year || 'N/A'}</td>
                    `;
                case 'resource':
                    return `
                        <td>${item.faculty_name || 'N/A'}</td>
                        <td>${item.department || 'N/A'}</td>
                        <td>${formatDateOnly(item.date_of_activity) || 'N/A'}</td>
                        <td>${item.college_name || 'N/A'}</td>
                        <td>${item.resource_activity || 'N/A'}</td>
                        <td>${item.remarks || 'N/A'}</td>
                    `;
                case 'books':
                    return `
                        <td>${item.faculty_name || 'N/A'}</td>
                        <td>${item.designation || 'N/A'}</td>
                        <td>${item.department || 'N/A'}</td>
                        <td>${item.book_type || 'N/A'}</td>
                        <td>${item.book_title || 'N/A'}</td>
                        <td>${item.isbn || 'N/A'}</td>
                        <td>${item.indexed_in || 'N/A'}</td>
                        <td>${item.publishing_agency || 'N/A'}</td>
                        <td>${item.month_and_year || 'N/A'}</td>
                    `;
                case 'industry-visits':
                    return `
                        <td>${item.faculty_name || 'N/A'}</td>
                        <td>${item.department || 'N/A'}</td>
                        <td>${item.industry_name || 'N/A'}</td>
                        <td>${formatDateOnly(item.visit_date) || 'N/A'}</td>
                        <td>${item.significance || 'N/A'}</td>
                        <td>${item.location || 'N/A'}</td>
                    `;
                case 'hrd-fdp':
                    return `
                        <td>${item.faculty_name || 'N/A'}</td>
                        <td>${item.department || 'N/A'}</td>
                        <td>${item.program_name || 'N/A'}</td>
                        <td>${item.program_type || 'N/A'}</td>
                        <td>${formatDateOnly(item.start_date) || 'N/A'}</td>
                        <td>${formatDateOnly(item.end_date) || 'N/A'}</td>
                        <td>${item.organized_by || 'N/A'}</td>
                        <td>${item.national_international || 'N/A'}</td>
                        <td>${item.mode || 'N/A'}</td>
                    `;
                case 'workshops':
                    return `
                        <td>${item.faculty_name || 'N/A'}</td>
                        <td>${item.department || 'N/A'}</td>
                        <td>${item.event_name || 'N/A'}</td>
                        <td>${item.national_international || 'N/A'}</td>
                        <td>${item.event_type || 'N/A'}</td>
                        <td>${formatDateOnly(item.start_date) || 'N/A'}</td>
                        <td>${formatDateOnly(item.end_date) || 'N/A'}</td>
                        <td>${item.organized_by || 'N/A'}</td>
                    `;
                case 'achievements':
                    return `
                        <td>${item.faculty_name || 'N/A'}</td>
                        <td>${item.department || 'N/A'}</td>
                        <td>${item.achievement_name || 'N/A'}</td>
                        <td>${item.awarded_by || 'N/A'}</td>
                        <td>${item.month_and_year || 'N/A'}</td>
                    `;
                case 'vedic-workshops':
                    return `
                        <td>${item.faculty_name || 'N/A'}</td>
                        <td>${item.department || 'N/A'}</td>
                        <td>${item.workshop_name || 'N/A'}</td>
                        <td>${formatDateOnly(item.event_date) || 'N/A'}</td>
                        <td>${item.venue || 'N/A'}</td>
                    `;
                case 'phd-supervisor':
                    return `
                        <td>${item.supervisor_name || 'N/A'}</td>
                        <td>${item.research_scholar_name || 'N/A'}</td>
                        <td>${item.department || 'N/A'}</td>
                        <td>${item.university_name || 'N/A'}</td>
                        <td>${item.full_time_part_time || 'N/A'}</td>
                        <td>${item.month_year_of_joining || 'N/A'}</td>
                        <td>${item.status || 'N/A'}</td>
                    `;
                case 'reviewer':
                    return `
                        <td>${item.faculty_name || 'N/A'}</td>
                        <td>${item.department || 'N/A'}</td>
                        <td>${formatDateOnly(item.date_of_review) || 'N/A'}</td>
                        <td>${item.conference_journal_name || 'N/A'}</td>
                        <td>${item.review_type || 'N/A'}</td>
                        <td>${item.remarks || 'N/A'}</td>
                    `;
                case 'certifications':
                    return `
                        <td>${item.faculty_name || 'N/A'}</td>
                        <td>${item.department || 'N/A'}</td>
                        <td>${item.course_title || 'N/A'}</td>
                        <td>${item.course_duration || 'N/A'}</td>
                        <td>${item.course_topic || 'N/A'}</td>
                        <td>${item.course_details || 'N/A'}</td>
                        <td>
                            ${item.certificate_path && (item.certificate_path.endsWith('.jpg') || item.certificate_path.endsWith('.jpeg') || item.certificate_path.endsWith('.png') || item.certificate_path.endsWith('.bmp'))
                                ? `<img src="${item.certificate_path}" alt="Certificate Image" style="max-width:100px;max-height:100px;" onerror="this.onerror=null;this.src='/static/images/vishnu-logo.jpg';">`
                                : (item.certificate_path ? `<a href="${item.certificate_path}" target="_blank" class="text-blue-600 hover:underline">View Certificate</a>` : 'N/A')}
                        </td>
                    `;
                case 'nptel-courses':
                    return `
                        <td>${item.faculty_name || 'N/A'}</td>
                        <td>${item.department || 'N/A'}</td>
                        <td>${item.course_title || 'N/A'}</td>
                        <td>${item.course_duration || 'N/A'}</td>
                        <td>${item.course_id || 'N/A'}</td>
                        <td>${item.score || 'N/A'}</td>
                        <td>${item.platform || 'N/A'}</td>
                        <td>${item.details || 'N/A'}</td>
                        <td>
                            ${item.certificate_path && (item.certificate_path.endsWith('.jpg') || item.certificate_path.endsWith('.jpeg') || item.certificate_path.endsWith('.png') || item.certificate_path.endsWith('.bmp'))
                                ? `<img src="${item.certificate_path}" alt="Certificate Image" style="max-width:100px;max-height:100px;" onerror="this.onerror=null;this.src='/static/images/vishnu-logo.jpg';">`
                                : (item.certificate_path ? `<a href="${item.certificate_path}" target="_blank" class="text-blue-600 hover:underline">View Certificate</a>` : 'N/A')}
                        </td>
                    `;
                default:
                    return '<td colspan="10">Data not available</td>';
            }
        }

        // Export PDF function for dashboard tables
        function exportPDF() {
            const pdf = new window.jspdf.jsPDF('l', 'pt', 'a4');
            const container = document.querySelector('.container.mx-auto.p-6.space-y-6');
            if (!container) {
                alert('No data to export!');
                return;
            }
            // Hide loading spinner if visible
            document.getElementById('loading').classList.add('hidden');

            // Use html2canvas to render the dashboard tables
            html2canvas(container, { scale: 2 }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();
                const imgProps = pdf.getImageProperties(imgData);
                const pdfWidth = pageWidth;
                const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;

                let position = 0;
                pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, pdfHeight);

                // If content is longer than one page, add more pages
                if (pdfHeight > pageHeight) {
                    let remainingHeight = pdfHeight - pageHeight;
                    let pageCount = Math.ceil(pdfHeight / pageHeight);
                    for (let i = 1; i < pageCount; i++) {
                        pdf.addPage();
                        pdf.addImage(imgData, 'PNG', 0, -i * pageHeight, pdfWidth, pdfHeight);
                    }
                }

                pdf.save('faculty-profile-dashboard.pdf');
            });
        }
    </script>
</body>
</html>